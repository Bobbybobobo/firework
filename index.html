<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>çƒŸèŠ±ç§€</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: radial-gradient(
          ellipse at bottom,
          #1b2735 0%,
          #090a0f 100%
        );
        overflow: hidden;
        font-family: "KaiTi", "æ¥·ä½“", "STKaiti", "åæ–‡æ¥·ä½“", serif;
        height: 100vh;
        position: relative;
      }

      /* å¼€åœºé¡µé¢ */
      #startScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        background: radial-gradient(
          ellipse at bottom,
          #1b2735 0%,
          #090a0f 100%
        );
        transition: opacity 1s ease-out;
      }

      #startScreen.hidden {
        opacity: 0;
        pointer-events: none;
      }

      #startScreen h1 {
        font-size: 2.5rem;
        color: #fff;
        margin-bottom: 30px;
        text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        animation: glow 2s ease-in-out infinite;
      }

      @keyframes glow {
        0%,
        100% {
          text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }
        50% {
          text-shadow: 0 0 30px rgba(255, 255, 255, 0.8),
            0 0 40px rgba(255, 182, 193, 0.6);
        }
      }

      #startButton {
        padding: 20px 50px;
        font-size: 1.5rem;
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: white;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.5);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      #startButton:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 12px 35px rgba(255, 107, 107, 0.7);
      }

      #startScreen p {
        margin-top: 30px;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.9rem;
      }

      canvas {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
      }

      .story-text-wrap {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 20;
        pointer-events: none;
        width: 90%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* æ•…äº‹æ–‡å­—æ˜¾ç¤º */
      #storyText {
        font-size: 2rem;
        font-weight: normal;
        color: #fff;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.8),
          0 0 20px rgba(135, 206, 250, 0.6), 0 0 30px rgba(135, 206, 250, 0.4),
          2px 2px 4px rgba(0, 0, 0, 0.5);
        opacity: 0;
        text-align: left;
        line-height: 1.8;
        letter-spacing: 0.01em;
        transition: opacity 1s ease-in-out;
        white-space: pre-line;
        font-family: "KaiTi", "æ¥·ä½“", "STKaiti", "åæ–‡æ¥·ä½“", serif;
      }

      #storyText.show {
        opacity: 1;
      }

      #finalMessage {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3.5rem;
        font-weight: bold;
        color: transparent;
        background: linear-gradient(
          45deg,
          #ff8c00,
          #ff6347,
          #ffa500,
          #ff7f00,
          #ffb347,
          #ff9500
        );
        background-size: 300% 300%;
        -webkit-background-clip: text;
        background-clip: text;
        text-shadow: 0 0 30px rgba(255, 140, 0, 1),
          0 0 60px rgba(255, 165, 0, 0.9), 0 0 90px rgba(255, 99, 71, 0.7);
        opacity: 0;
        animation: gradientShift 3s ease-in-out infinite;
        letter-spacing: 0.1em;
        z-index: 20;
        text-align: center;
        line-height: 1.3;
        pointer-events: none;
        display: none;
      }

      @keyframes gradientShift {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }

      @keyframes fadeIn {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.8);
        }
        100% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      #controls {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 100;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
        width: calc(100% - 40px);
        opacity: 0;
        transition: opacity 0.5s ease;
      }

      #controls.show {
        opacity: 1;
      }

      button {
        padding: 12px 30px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 25px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .music-btn {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        min-width: 120px;
      }

      .music-btn:hover {
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
      }

      #musicIndicator {
        position: absolute;
        top: 30px;
        right: 30px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 12px 20px;
        border-radius: 20px;
        font-size: 0.95rem;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 100;
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        gap: 15px;
      }

      #musicIndicator.show {
        opacity: 1;
      }

      #soundToggle {
        cursor: pointer;
        font-size: 1.2rem;
        transition: transform 0.2s ease;
        user-select: none;
      }

      #soundToggle:hover {
        transform: scale(1.2);
      }

      #soundToggle:active {
        transform: scale(0.9);
      }

      /* ç§»åŠ¨ç«¯é€‚é… */
      @media (max-width: 768px) {
        #storyText {
          font-size: 1.3rem;
          line-height: 1.6;
          padding: 0 20px;
        }
        #startScreen h1 {
          font-size: 1.8rem;
        }
        #startButton {
          font-size: 1.2rem;
          padding: 15px 40px;
        }
        button {
          padding: 10px 20px;
          font-size: 0.9rem;
        }
        #musicIndicator {
          top: 15px;
          right: 15px;
          font-size: 0.85rem;
          padding: 8px 15px;
        }
      }

      @media (max-width: 480px) {
        #storyText {
          font-size: 1.5rem;
          line-height: 1.6;
        }
        #startScreen h1 {
          font-size: 1.5rem;
        }
        #startButton {
          font-size: 1rem;
          padding: 12px 30px;
        }
      }
    </style>
  </head>
  <body>
    <!-- å¼€åœºé¡µé¢ -->
    <div id="startScreen">
      <h1>âœ¨ å‡†å¤‡å¥½äº†å—ğŸ˜Š âœ¨</h1>
      <button id="startButton">ğŸ† ç‚¹äº®æ˜Ÿç©º ğŸ†</button>
      <p>ğŸ’ å»ºè®®ä½©æˆ´è€³æœºè·å¾—æœ€ä½³ä½“éªŒ ğŸ’</p>
    </div>

    <canvas id="canvas"></canvas>
    <div class="story-text-wrap">
      <div id="storyText"></div>
    </div>
    <div id="finalMessage"></div>
    <div id="musicIndicator">
      <span id="soundToggle">ğŸ”Š</span>
      <span id="musicName">ğŸ° å¤©ç©ºä¹‹åŸ</span>
    </div>

    <div id="controls">
      <button id="replayBtn">ğŸ”„ é‡æ–°æ’­æ”¾</button>
      <button id="musicBtn" class="music-btn">ğŸµ åˆ‡æ¢éŸ³ä¹</button>
    </div>

    <script>
      // éŸ³ä¹åˆ—è¡¨
      const musicList = [
        { name: "å¤©ç©ºä¹‹åŸ", file: "å¤©ç©ºä¹‹åŸ.mp3", icon: "ğŸ°" },
        { name: "Marry You", file: "Marry_You.mp3", icon: "ğŸ’" },
        { name: "ä¹Œå…°å·´æ‰˜çš„å¤œ", file: "ä¹Œå…°å·´æ‰˜çš„å¤œ.m4a", icon: "ğŸŒ™" },
        { name: "ä¸ƒé‡Œé¦™", file: "ä¸ƒé‡Œé¦™.mp3", icon: "ğŸŒ¸" },
        { name: "æ„¿ä½ ", file: "æ„¿ä½ .mp3", icon: "ğŸ’«" },
        { name: "æ•…ä¹¡çš„åŸé£æ™¯", file: "æ•…ä¹¡çš„åŸé£æ™¯.mp3", icon: "ğŸï¸" },
        { name: "Against the Tide", file: "Against_the_Tide.mp3", icon: "ğŸŒŠ" },
      ];

      let currentMusicIndex = 0;
      let audio = new Audio();
      let isPlaying = false;
      let isMuted = false;

      // é¢„åŠ è½½æ‰€æœ‰éŸ³ä¹æ–‡ä»¶
      const audioCache = {};
      function preloadAudio() {
        musicList.forEach((music, index) => {
          const audioElement = new Audio();
          audioElement.src = music.file;
          audioElement.preload = "auto";
          audioCache[index] = audioElement;
        });
      }

      // é¡µé¢åŠ è½½æ—¶é¢„åŠ è½½éŸ³é¢‘
      window.addEventListener("load", preloadAudio);

      // æ•…äº‹æ–‡å­—å†…å®¹ï¼ˆ8æ®µï¼Œä¸¥æ ¼æŒ‰ç…§æ’ç‰ˆï¼‰
      const fireworkTexts = [
        "ğŸŒŒ ä»å°å¬è€äººè¯´ï¼Œ\nå¤©ä¸Šä½ç€ç¥ä»™ï¼Œ",
        "ä»–ä»¬ç”¨æ˜Ÿæ˜Ÿçš„å…‰ï¼Œ\nè®°å½•æ¯ä¸€ä¸ªæ„¿æœ›ã€‚",
        "â˜ï¸ åæ¥æˆ‘æ‰çŸ¥é“ï¼Œ\næ˜Ÿæ˜Ÿä¸ä¼šå›ç­”ï¼Œ",
        "ä½†æœ‰äº›äººå‡ºç°æ—¶ï¼Œ\nå¤œç©ºå°±äº®äº†ã€‚",
        "ğŸ’« æœ‰äººè¯´ï¼ŒçƒŸèŠ±çŸ­æš‚ï¼Œ\nå´æœ€æ¥è¿‘æ°¸æ’ã€‚",
        "å› ä¸ºé‚£ä¸€ç¬é—´ï¼Œ\næˆ‘ä»¬éƒ½ç›¸ä¿¡äº†å…‰ã€‚",
        "ğŸŒ™ ä»Šæ™šè¿™ç‰‡å¤©ç©ºçš„å…‰ï¼Œ\næƒ³å‘Šè¯‰ä½ â€”â€”",
        "æ„¿ä½ æ‰€æœ‰çœŸè¯šä¸å‹‡æ°”ï¼Œ\néƒ½è¢«ä¸–ç•Œæ¸©æŸ”ç›¸å¾…ã€‚",
      ];

      let currentTextIndex = 0;
      let textDisplayTimeout = null;

      // Canvas è®¾ç½®
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      window.addEventListener("resize", () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        initStars();
      });

      // å…¨å±€å˜é‡
      let fireworks = [];
      let stars = [];
      let shootingStars = [];
      let animationId = null;
      let hasStarted = false;

      // æ˜Ÿæ˜Ÿç±»
      class Star {
        constructor() {
          this.x = Math.random() * canvas.width;
          this.y = Math.random() * canvas.height;
          this.size = Math.random() * 2 + 0.5;
          this.brightness = Math.random() * 0.5 + 0.5;
          this.twinkleSpeed = Math.random() * 0.02 + 0.01;
          this.twinklePhase = Math.random() * Math.PI * 2;
        }

        update() {
          this.twinklePhase += this.twinkleSpeed;
        }

        draw() {
          const twinkle = ((Math.sin(this.twinklePhase) + 1) / 2) * 0.5 + 0.5;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(255, 255, 255, ${this.brightness * twinkle})`;
          ctx.fill();
        }
      }

      // æµæ˜Ÿç±»
      class ShootingStar {
        constructor() {
          this.reset();
        }

        reset() {
          this.x = Math.random() * canvas.width;
          this.y = 0;
          this.length = Math.random() * 80 + 60;
          this.speed = Math.random() * 10 + 15;
          this.size = Math.random() * 2 + 1;
          this.angle = Math.PI / 4 + (Math.random() - 0.5) * 0.5;
          this.alpha = 1;
          this.fadeSpeed = Math.random() * 0.02 + 0.02;
        }

        update() {
          this.x += Math.cos(this.angle) * this.speed;
          this.y += Math.sin(this.angle) * this.speed;
          this.alpha -= this.fadeSpeed;
        }

        draw() {
          ctx.save();
          ctx.translate(this.x, this.y);
          ctx.rotate(this.angle);

          const gradient = ctx.createLinearGradient(0, 0, -this.length, 0);
          gradient.addColorStop(0, `rgba(255, 255, 255, ${this.alpha})`);
          gradient.addColorStop(
            0.5,
            `rgba(200, 200, 255, ${this.alpha * 0.6})`
          );
          gradient.addColorStop(1, "rgba(255, 255, 255, 0)");

          ctx.strokeStyle = gradient;
          ctx.lineWidth = this.size;
          ctx.beginPath();
          ctx.moveTo(0, 0);
          ctx.lineTo(-this.length, 0);
          ctx.stroke();

          ctx.restore();
        }

        isDead() {
          return this.alpha <= 0 || this.y > canvas.height;
        }
      }

      // çƒŸèŠ±ç²’å­ç±»
      class Particle {
        constructor(x, y, vx, vy, color, size, life, parent = null) {
          this.x = x;
          this.y = y;
          this.vx = vx;
          this.vy = vy;
          this.color = color;
          this.size = size;
          this.life = life;
          this.maxLife = life;
          this.gravity = 0.08;
          this.parent = parent;
          this.glowIntensity = Math.random() * 0.5 + 0.5;
        }

        update() {
          this.x += this.vx;
          this.y += this.vy;
          this.vy += this.gravity;

          if (this.parent && this.parent.isFinale) {
            this.vx *= 0.99;
            this.vy *= 0.99;
            this.size *= 0.995;
          } else {
            this.vx *= 0.995;
            this.vy *= 0.995;
            this.size *= 0.998;
          }

          this.life--;
        }

        draw() {
          const alpha = this.life / this.maxLife;
          if (alpha <= 0) return;

          ctx.save();
          ctx.globalAlpha = alpha;

          if (this.size > 2) {
            ctx.shadowBlur = 10 * this.glowIntensity;
            ctx.shadowColor = this.color;
          }

          ctx.fillStyle = this.color;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fill();

          if (this.size > 2.5) {
            ctx.globalAlpha = alpha * 0.8;
            ctx.fillStyle = "white";
            ctx.shadowBlur = 0;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size * 0.35, 0, Math.PI * 2);
            ctx.fill();
          }

          ctx.restore();
        }
      }

      // çƒŸèŠ±ç±»
      class Firework {
        constructor(sx, sy, tx, ty) {
          this.x = sx;
          this.y = sy;
          this.sx = sx;
          this.sy = sy;
          this.tx = tx;
          this.ty = ty;
          this.distanceToTarget = this.calculateDistance(sx, sy, tx, ty);
          this.distanceTraveled = 0;
          this.coordinates = [];
          this.coordinateCount = 5;
          while (this.coordinateCount--) {
            this.coordinates.push([this.x, this.y]);
          }
          this.angle = Math.atan2(ty - sy, tx - sx);
          this.speed = 2.5;
          this.acceleration = 1.05;
          this.brightness = Math.random() * 30 + 70;
          this.targetRadius = 1;
          this.exploded = false;
          this.particles = [];
          this.isFinale = false;
        }

        calculateDistance(x1, y1, x2, y2) {
          return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        }

        update() {
          if (!this.exploded) {
            this.coordinates.pop();
            this.coordinates.unshift([this.x, this.y]);

            if (this.targetRadius < 8) {
              this.targetRadius += 0.3;
            } else {
              this.targetRadius = 1;
            }

            this.speed *= this.acceleration;
            const vx = Math.cos(this.angle) * this.speed;
            const vy = Math.sin(this.angle) * this.speed;

            this.distanceTraveled = this.calculateDistance(
              this.sx,
              this.sy,
              this.x + vx,
              this.y + vy
            );

            if (this.distanceTraveled >= this.distanceToTarget) {
              this.explode();
            } else {
              this.x += vx;
              this.y += vy;
            }
          } else {
            for (let i = this.particles.length - 1; i >= 0; i--) {
              this.particles[i].update();
              if (this.particles[i].life <= 0) {
                this.particles.splice(i, 1);
              }
            }
          }
        }

        explode() {
          this.exploded = true;

          // çˆ±å¿ƒå½¢çŠ¶çƒŸèŠ±
          if (this.shape === 'heart') {
            const particleCount = 80;
            const hue = 0; // çº¢è‰²/ç²‰è‰²

            for (let i = 0; i < particleCount; i++) {
              const t = (i / particleCount) * Math.PI * 2;
              // çˆ±å¿ƒå‚æ•°æ–¹ç¨‹
              const x = 16 * Math.pow(Math.sin(t), 3);
              const y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
              
              const scale = 0.3;
              const vx = x * scale;
              const vy = y * scale;
              
              const color = `hsl(${hue + Math.random() * 30}, 100%, ${Math.random() * 20 + 60}%)`;
              const size = Math.random() * 3 + 2;
              const life = Math.random() * 40 + 60;

              const particle = new Particle(
                this.tx,
                this.ty,
                vx,
                vy,
                color,
                size,
                life,
                this
              );
              particle.gravity = 0.05;
              this.particles.push(particle);
            }
          }
          // æ˜Ÿæ˜Ÿå½¢çŠ¶çƒŸèŠ±
          else if (this.shape === 'star') {
            const particleCount = 100;
            const hue = 50; // é‡‘é»„è‰²

            // äº”è§’æ˜Ÿçš„5ä¸ªè§’
            for (let i = 0; i < particleCount; i++) {
              const angle = (i / particleCount) * Math.PI * 2;
              const starAngle = Math.floor(angle / (Math.PI * 2 / 5)) * (Math.PI * 2 / 5);
              const nextStarAngle = starAngle + (Math.PI * 2 / 5);
              
              // åœ¨äº”è§’æ˜Ÿçš„è¾¹ç¼˜åˆ†å¸ƒ
              const t = (angle - starAngle) / (Math.PI * 2 / 5);
              const outerRadius = 4;
              const innerRadius = 1.5;
              
              let radius;
              if (t < 0.5) {
                radius = outerRadius;
              } else {
                radius = innerRadius + (outerRadius - innerRadius) * Math.cos((t - 0.5) * Math.PI * 2);
              }
              
              const vx = Math.cos(angle) * radius;
              const vy = Math.sin(angle) * radius;
              
              const color = `hsl(${hue + Math.random() * 30}, 100%, ${Math.random() * 20 + 70}%)`;
              const size = Math.random() * 3 + 2;
              const life = Math.random() * 40 + 60;

              const particle = new Particle(
                this.tx,
                this.ty,
                vx,
                vy,
                color,
                size,
                life,
                this
              );
              particle.gravity = 0.05;
              this.particles.push(particle);
            }
          }
          // æ™®é€šçƒŸèŠ±
          else if (this.isFinale) {
            const particleCount = 30;
            const hue = Math.random() * 360;

            for (let i = 0; i < particleCount; i++) {
              const angle = ((Math.PI * 2) / particleCount) * i;
              const velocity = Math.random() * 4 + 2;
              const vx = Math.cos(angle) * velocity;
              const vy = Math.sin(angle) * velocity;
              const color = `hsl(${hue}, 100%, ${Math.random() * 20 + 60}%)`;
              const size = Math.random() * 2 + 1;
              const life = Math.random() * 30 + 45;

              const particle = new Particle(
                this.tx,
                this.ty,
                vx,
                vy,
                color,
                size,
                life,
                this
              );
              particle.gravity = 0.06;
              this.particles.push(particle);
            }
          } else {
            const particleCount = 45;
            const hue = Math.random() * 360;

            for (let i = 0; i < particleCount; i++) {
              const angle = ((Math.PI * 2) / particleCount) * i;
              const velocity = Math.random() * 6 + 3.5;
              const vx = Math.cos(angle) * velocity;
              const vy = Math.sin(angle) * velocity;
              const color = `hsl(${hue}, 100%, ${Math.random() * 30 + 50}%)`;
              const size = Math.random() * 3 + 1.5;
              const life = Math.random() * 40 + 55;

              this.particles.push(
                new Particle(this.tx, this.ty, vx, vy, color, size, life, this)
              );
            }

            for (let i = 0; i < 15; i++) {
              const angle = Math.random() * Math.PI * 2;
              const velocity = Math.random() * 3 + 1;
              const vx = Math.cos(angle) * velocity;
              const vy = Math.sin(angle) * velocity;
              const color = `hsl(${hue + 30}, 100%, 80%)`;
              const size = Math.random() * 2 + 1;
              const life = Math.random() * 20 + 35;

              this.particles.push(
                new Particle(this.tx, this.ty, vx, vy, color, size, life, this)
              );
            }
          }
        }

        draw() {
          if (!this.exploded) {
            ctx.save();

            const gradient = ctx.createLinearGradient(
              this.coordinates[this.coordinates.length - 1][0],
              this.coordinates[this.coordinates.length - 1][1],
              this.x,
              this.y
            );
            gradient.addColorStop(0, `hsl(${Math.random() * 360}, 100%, 30%)`);
            gradient.addColorStop(
              1,
              `hsl(${Math.random() * 360}, 100%, ${this.brightness}%)`
            );

            ctx.strokeStyle = gradient;
            ctx.lineWidth = 3;
            ctx.shadowBlur = 10;
            ctx.shadowColor = `hsl(${Math.random() * 360}, 100%, ${
              this.brightness
            }%)`;

            ctx.beginPath();
            ctx.moveTo(
              this.coordinates[this.coordinates.length - 1][0],
              this.coordinates[this.coordinates.length - 1][1]
            );
            ctx.lineTo(this.x, this.y);
            ctx.stroke();

            ctx.beginPath();
            ctx.arc(this.x, this.y, this.targetRadius, 0, Math.PI * 2);
            ctx.fillStyle = `hsl(${Math.random() * 360}, 100%, ${
              this.brightness
            }%)`;
            ctx.shadowBlur = 15;
            ctx.fill();
            ctx.restore();
          } else {
            for (let particle of this.particles) {
              particle.draw();
            }
          }
        }

        isDead() {
          return this.exploded && this.particles.length === 0;
        }
      }

      // åˆå§‹åŒ–æ˜Ÿç©º
      function initStars() {
        stars = [];
        for (let i = 0; i < 200; i++) {
          stars.push(new Star());
        }
      }

      // éŸ³ä¹æ§åˆ¶
      function playMusic() {
        if (isMuted) return;

        // ä½¿ç”¨é¢„åŠ è½½çš„éŸ³é¢‘
        if (audioCache[currentMusicIndex]) {
          audio = audioCache[currentMusicIndex];
        } else {
          audio.src = musicList[currentMusicIndex].file;
        }

        audio.loop = true;
        audio
          .play()
          .then(() => {
            isPlaying = true;
            updateMusicIndicator();
          })
          .catch((e) => {
            console.log("éŸ³ä¹æ’­æ”¾å¤±è´¥:", e);
          });
      }

      function stopMusic() {
        audio.pause();
        audio.currentTime = 0;
        isPlaying = false;
      }

      function switchMusic() {
        // å…ˆåœæ­¢å½“å‰éŸ³ä¹
        if (audio) {
          audio.pause();
          audio.currentTime = 0;
        }
        
        // åˆ‡æ¢åˆ°ä¸‹ä¸€é¦–
        currentMusicIndex = (currentMusicIndex + 1) % musicList.length;
        
        // å¦‚æœä¸æ˜¯é™éŸ³çŠ¶æ€ï¼Œæ’­æ”¾æ–°éŸ³ä¹
        if (!isMuted) {
          playMusic();
        } else {
          // å³ä½¿æ˜¯é™éŸ³çŠ¶æ€ä¹Ÿæ›´æ–°æ˜¾ç¤º
          updateMusicIndicator();
        }
      }

      function toggleSound() {
        isMuted = !isMuted;
        const soundToggle = document.getElementById("soundToggle");

        if (isMuted) {
          // æš‚åœéŸ³ä¹ï¼Œä¸é‡ç½®è¿›åº¦
          audio.pause();
          isPlaying = false;
          soundToggle.textContent = "ğŸ”‡";
        } else {
          // ç»§ç»­æ’­æ”¾éŸ³ä¹
          audio.play().then(() => {
            isPlaying = true;
            soundToggle.textContent = "ğŸ”Š";
          }).catch((e) => {
            console.log("éŸ³ä¹æ’­æ”¾å¤±è´¥:", e);
          });
        }
      }

      function updateMusicIndicator() {
        const musicName = document.getElementById("musicName");
        const current = musicList[currentMusicIndex];
        musicName.textContent = `${current.icon} ${current.name}`;
        if (isPlaying && !isMuted) {
          document.getElementById("musicIndicator").classList.add("show");
        }
      }

      // åˆ›å»ºçƒŸèŠ±
      function createRandomFirework() {
        const startX = Math.random() * canvas.width;
        const startY = canvas.height;
        const endX = Math.random() * canvas.width;
        const endY = Math.random() * canvas.height * 0.5;

        const firework = new Firework(startX, startY, endX, endY);
        fireworks.push(firework);
        return firework;
      }

      function createHeartFirework() {
        const startX = Math.random() * canvas.width;
        const startY = canvas.height;
        const endX = Math.random() * canvas.width;
        const endY = Math.random() * canvas.height * 0.4 + canvas.height * 0.2;

        const firework = new Firework(startX, startY, endX, endY);
        firework.shape = 'heart';
        fireworks.push(firework);
        return firework;
      }

      function createStarFirework() {
        const startX = Math.random() * canvas.width;
        const startY = canvas.height;
        const endX = Math.random() * canvas.width;
        const endY = Math.random() * canvas.height * 0.4 + canvas.height * 0.2;

        const firework = new Firework(startX, startY, endX, endY);
        firework.shape = 'star';
        fireworks.push(firework);
        return firework;
      }

      function createMultipleFireworks(count = 3) {
        for (let i = 0; i < count; i++) {
          setTimeout(() => createRandomFirework(), i * 150);
        }
      }

      // åˆ›å»ºåº•éƒ¨ä¸€æ’çƒŸèŠ±é½å°„æ•ˆæœ
      function createBottomRowFireworks() {
        const screenWidth = canvas.width;
        const fireworkCount = 20;
        const spacing = screenWidth / (fireworkCount + 1);

        // ç¬¬ä¸€æ³¢
        for (let i = 0; i < fireworkCount; i++) {
          setTimeout(() => {
            const startX = spacing * (i + 1);
            const startY = canvas.height;
            const endX = startX + (Math.random() - 0.5) * 100;
            const endY = Math.random() * canvas.height * 0.6 + 50;

            const firework = new Firework(startX, startY, endX, endY);
            firework.isFinale = true;
            fireworks.push(firework);
          }, i * 60);
        }

        // ç¬¬äºŒæ³¢
        setTimeout(() => {
          for (let i = 0; i < Math.floor(fireworkCount * 0.9); i++) {
            setTimeout(() => {
              const startX = spacing * (i + 1) + (Math.random() - 0.5) * 60;
              const startY = canvas.height;
              const endX = startX + (Math.random() - 0.5) * 120;
              const endY = Math.random() * canvas.height * 0.7 + 30;

              const firework = new Firework(startX, startY, endX, endY);
              firework.isFinale = true;
              fireworks.push(firework);
            }, i * 50);
          }
        }, 900);

        // ç¬¬ä¸‰æ³¢
        setTimeout(() => {
          for (let i = 0; i < Math.floor(fireworkCount * 0.8); i++) {
            setTimeout(() => {
              const startX = Math.random() * screenWidth;
              const startY = canvas.height;
              const endX = Math.random() * screenWidth;
              const endY = Math.random() * canvas.height * 0.5;

              const firework = new Firework(startX, startY, endX, endY);
              firework.isFinale = true;
              fireworks.push(firework);
            }, i * 40);
          }
        }, 1800);
      }

      // æ˜¾ç¤ºä¸‹ä¸€ä¸ªæ–‡å­—ï¼ˆæ™®é€šæ–‡å­—ï¼Œéç²’å­ï¼‰
      function showNextText() {
        if (currentTextIndex < fireworkTexts.length) {
          const storyTextElement = document.getElementById("storyText");

          // æ·¡å‡ºå½“å‰æ–‡å­—
          storyTextElement.classList.remove("show");

          setTimeout(() => {
            // æ›´æ–°æ–‡å­—å†…å®¹
            storyTextElement.textContent = fireworkTexts[currentTextIndex];

            // æ·¡å…¥æ–°æ–‡å­—
            storyTextElement.classList.add("show");

            // å¦‚æœæ˜¯æœ€åä¸€å¥ï¼Œè§¦å‘ç‰¹æ®ŠçƒŸèŠ±æ•ˆæœ
            if (currentTextIndex === fireworkTexts.length - 1) {
              // åˆ›å»ºçˆ±å¿ƒå’Œæ˜Ÿæ˜ŸçƒŸèŠ±
              for (let i = 0; i < 3; i++) {
                setTimeout(() => createHeartFirework(), i * 800);
                setTimeout(() => createStarFirework(), i * 800 + 400);
              }
              
              // 2ç§’åè§¦å‘åº•éƒ¨é½å°„
              setTimeout(() => {
                createBottomRowFireworks();
              }, 2000);
            } else {
              // æ™®é€šçƒŸèŠ±
              createMultipleFireworks(5);
            }

            currentTextIndex++;

            // æ¯æ®µæ–‡å­—æ˜¾ç¤º5ç§’åæ˜¾ç¤ºä¸‹ä¸€æ®µ
            textDisplayTimeout = setTimeout(() => {
              showNextText();
            }, 5000);
          }, 1000);
        } else {
          // æ–‡å­—æ’­æ”¾å®Œæ¯•ï¼Œéšè—æ–‡å­—ï¼Œç»§ç»­æ’­æ”¾çƒŸèŠ±
          const storyTextElement = document.getElementById("storyText");
          storyTextElement.classList.remove("show");
          // ä¸æ˜¾ç¤ºfinalMessageï¼Œåªæ˜¯æŒç»­æ’­æ”¾çƒŸèŠ±
        }
      }

      // ä¸»åŠ¨ç”»å¾ªç¯
      function animate() {
        animationId = requestAnimationFrame(animate);

        ctx.fillStyle = "rgba(0, 0, 0, 0.15)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        for (let star of stars) {
          star.update();
          star.draw();
        }

        for (let i = shootingStars.length - 1; i >= 0; i--) {
          shootingStars[i].update();
          shootingStars[i].draw();

          if (shootingStars[i].isDead()) {
            shootingStars.splice(i, 1);
          }
        }

        if (Math.random() < 0.015 && shootingStars.length < 5) {
          shootingStars.push(new ShootingStar());
        }

        for (let i = fireworks.length - 1; i >= 0; i--) {
          fireworks[i].update();
          fireworks[i].draw();

          if (fireworks[i].isDead()) {
            fireworks.splice(i, 1);
          }
        }

        // æŒç»­åˆ›å»ºçƒŸèŠ±ï¼ˆæ°¸ä¸åœæ­¢ï¼‰
        if (hasStarted) {
          if (Math.random() < 0.06 && fireworks.length < 10) {
            createRandomFirework();
          }

          if (Math.random() < 0.03) {
            createMultipleFireworks(2);
          }
        }
      }

      // å¼€å§‹è¡¨æ¼”
      function startShow() {
        fireworks = [];
        currentTextIndex = 0;

        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (textDisplayTimeout) {
          clearTimeout(textDisplayTimeout);
        }

        // é‡ç½®æ–‡å­—æ˜¾ç¤º
        const storyTextElement = document.getElementById("storyText");
        storyTextElement.classList.remove("show");
        storyTextElement.textContent = "";

        initStars();
        createMultipleFireworks(5);

        // 2ç§’åå¼€å§‹æ˜¾ç¤ºç¬¬ä¸€æ®µæ–‡å­—
        setTimeout(() => {
          showNextText();
        }, 2000);

        if (animationId) {
          cancelAnimationFrame(animationId);
        }
        animate();
      }

      // å¼€åœºæŒ‰é’®äº‹ä»¶
      document
        .getElementById("startButton")
        .addEventListener("click", function () {
          if (hasStarted) return;
          hasStarted = true;

          // éšè—å¼€åœºé¡µé¢
          document.getElementById("startScreen").classList.add("hidden");

          // æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
          setTimeout(() => {
            document.getElementById("controls").classList.add("show");
          }, 1000);

          // å¼€å§‹æ’­æ”¾éŸ³ä¹ï¼ˆé»˜è®¤å¼€å¯ï¼‰
          if (!isMuted) {
            playMusic();
          }

          // å¼€å§‹çƒŸèŠ±ç§€
          startShow();
        });

      // é‡æ–°æ’­æ”¾æŒ‰é’®
      document
        .getElementById("replayBtn")
        .addEventListener("click", function () {
          startShow();
        });

      // åˆ‡æ¢éŸ³ä¹æŒ‰é’®
      document
        .getElementById("musicBtn")
        .addEventListener("click", function () {
          switchMusic();
        });

      // å£°éŸ³å›¾æ ‡ç‚¹å‡»äº‹ä»¶
      document
        .getElementById("soundToggle")
        .addEventListener("click", function () {
          toggleSound();
        });

      // åˆå§‹åŒ–æ˜Ÿç©º
      initStars();

      // å¼€åœºé¡µé¢çš„æ˜Ÿç©ºåŠ¨ç”»
      function startScreenAnimate() {
        if (!hasStarted) {
          requestAnimationFrame(startScreenAnimate);

          ctx.fillStyle = "rgba(0, 0, 0, 0.1)";
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          for (let star of stars) {
            star.update();
            star.draw();
          }

          if (Math.random() < 0.01 && shootingStars.length < 3) {
            shootingStars.push(new ShootingStar());
          }

          for (let i = shootingStars.length - 1; i >= 0; i--) {
            shootingStars[i].update();
            shootingStars[i].draw();

            if (shootingStars[i].isDead()) {
              shootingStars.splice(i, 1);
            }
          }
        }
      }

      startScreenAnimate();
    </script>
  </body>
</html>